services:
  onre-sol:
    platform: linux/amd64
    container_name: onre-sol-tests
    build:
      context: .
      dockerfile: Dockerfile
      # Disable cache to reduce disk usage during build
      no_cache: false
    volumes:
      # Named volume for building (avoids SIGILL)
      - target:/workspace/target
      # Bind mount for output artifacts
      - ./target:/workspace/output
      - cargo-cache:/root/.cargo/registry
      - cargo-git:/root/.cargo/git
    environment:
      - NODE_ENV=test
      - NODE_OPTIONS=--max-old-space-size=2048
    restart: "no"
    # Generous memory limits - VM has 7.6GB RAM available
    mem_limit: 6g
    memswap_limit: 6g
    shm_size: 2g

volumes:
  target:
  cargo-cache:
  cargo-git:
